bash -c "$(cat <<'EOF'
#!/bin/bash
set -e

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

# Configuration
TARIFF_API="http://nowlege.com/tariff-api/api/Tariff"
SIMCARD_API="http://nowlege.com/simcard-api/api/SimCard"
SIMCARD_VIEW_API="http://nowlege.com/simcard-view/api/SimCard"
SIMCARD_NUMBER="+380666666666"
STEP_DELAY=${STEP_DELAY:-10}

# Forward Postgres port
kubectl port-forward svc/postgres-service 5432:5432 -n tariff-plan-app >/dev/null 2>&1 &
PORT_FORWARD_PID=$!
sleep 2

# Postgres credentials
PGHOST=127.0.0.1
PGPORT=5432
PGUSER=postgres
PGDATABASE= postgres
PGPASSWORD= postgrespassword
export PGPASSWORD

function cleanup { kill $PORT_FORWARD_PID; }
trap cleanup EXIT

function check_response {
  local resp="$1"
  local step="$2"
  if [ -z "$resp" ]; then
    echo -e "${RED}Error: $step failed${NC}"; exit 1
  else
    echo -e "${GREEN}$step succeeded${NC}"
  fi
}

echo "Step 1: Create Tariff Draft"
TARIFF_DRAFT_JSON='{ "name": "Simple", "perMinuteCost": 0.25, "smsCost": 0.1, "connectionFee": 0.15, "perSecondBilling": 10, "externalIncomingCallPerSecondReward": 0.2, "bonusForRecharge": {"amount":100,"value":10,"expiresIn":30}, "serviceBundle": {"recurring": {"price":300,"callMinutesAmount":500,"smsAmount":500,"expiresIn":28}, "daily": {"price":15,"callMinutesAmount":10,"smsAmount":10,"expiresIn":1}}, "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6" }'
TARIFF_DRAFT_ID=$(curl -s -X POST "$TARIFF_API/create-tariff-draft" -H "Content-Type: application/json" -d "$TARIFF_DRAFT_JSON")
check_response "$TARIFF_DRAFT_ID" "Create Tariff Draft"
echo "Tariff Draft ID: $TARIFF_DRAFT_ID"
sleep $STEP_DELAY

echo "Step 2: Create Tariff"
TARIFF_ID=$(curl -s -X POST "$TARIFF_API/create-tariff" -H "Content-Type: application/json" -d "\"$TARIFF_DRAFT_ID\"")
check_response "$TARIFF_ID" "Create Tariff"
echo "Tariff ID: $TARIFF_ID"
sleep $STEP_DELAY

echo "Step 3: Create SimCard"
SIMCARD_JSON=$(jq -n --arg number "$SIMCARD_NUMBER" --arg tariffId "$TARIFF_ID" '{number: $number, tariff: {id: $tariffId, name: "Simple", perMinuteCost: 0.25, smsCost: 0.1, connectionFee:0.15, perSecondBilling:10, externalIncomingCallPerSecondReward:0.2, bonusForRecharge:{amount:100,value:10,expiresIn:30}, serviceBundle:{recurring:{price:300,callMinutesAmount:500,smsAmount:500,expiresIn:28}, daily:{price:15,callMinutesAmount:10,smsAmount:10,expiresIn:1}}}, defaultExpiration:180, amountToExtendExpiration:10, balance:10, discountForPersonalization:10}')
curl -s -X POST "$SIMCARD_API/create" -H "Content-Type: application/json" -d "$SIMCARD_JSON"
echo -e "${GREEN}SimCard creation request sent${NC}"
sleep $STEP_DELAY

echo "Step 4: Get SimCard ID from Postgres"
MAX_RETRIES=5; RETRY_DELAY=2; SIMCARD_ID=""
for i in $(seq 1 $MAX_RETRIES); do
  SIMCARD_ID=$(psql -h $PGHOST -p $PGPORT -U $PGUSER -d $PGDATABASE -t -c "SELECT Id FROM SimCardSummary WHERE Number='$SIMCARD_NUMBER';" | xargs)
  if [ -n "$SIMCARD_ID" ]; then echo -e "${GREEN}SimCard ID found in Postgres${NC}"; break; fi
  echo "Retry $i/$MAX_RETRIES: waiting for SimCard record..."; sleep $RETRY_DELAY
done
[ -z "$SIMCARD_ID" ] && echo -e "${RED}Error: SimCard ID not found in Postgres${NC}" && exit 1
echo "SimCard ID: $SIMCARD_ID"
sleep $STEP_DELAY

echo "Step 5: Get SimCard from API"
SIMCARD_RESPONSE=$(curl -s "$SIMCARD_VIEW_API/get-simcard/$SIMCARD_ID")
[ -z "$SIMCARD_RESPONSE" ] && echo -e "${RED}Error: Failed to get SimCard from API${NC}" && exit 1
echo -e "${GREEN}SimCard retrieved successfully:${NC}"
echo "$SIMCARD_RESPONSE" | jq
EOF
)"
